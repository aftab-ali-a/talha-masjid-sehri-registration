<!DOCTYPE html>
<html>
<head>
    <title>Ramadan Sehri Registration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; padding: 20px; max-width: 500px; margin: auto; }
        input, select, button { width: 100%; padding: 10px; margin-top: 10px; }
        button { background: green; color: white; border: none; }
        button:disabled { background: grey; }
        #message { margin-top: 15px; font-weight: bold; }
        #map { height: 300px; margin-top: 10px; display: none; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<h3>Women's Sehri Registration At Masjid-E-Talha</h3>

<form id="sehri-form" onsubmit="return submitToGoogleForm(event)">

    <label>Name</label>
    <input 
        type="text"
        id="name"
        required
        placeholder="Enter Your Name" 
    />

    <label>Phone Number</label>
    <input 
        type="tel" 
        id="phone" 
        required
        pattern="[0-9]{10}"
        maxlength="10"
        minlength="10"
        placeholder="Enter 10-digit phone number"
    />

    <label>Food Preference</label>
    <select id="food" required>
        <option value="">Select Your Food Preference</option>
        <option>Veg</option>
        <option>Non-Veg</option>
    </select>

    <label>Location</label>
    <select id="locMethod" onchange="toggleMap()" required>
        <option value="">Select Location</option>
        <option value="current">Use Current Location (GPS)</option>
        <option value="manual">Select Location on Map</option>
    </select>

    <button type="button" onclick="verifyLocation()">Check if Sehri Delivery Is Available in Your Area</button>
    <button type="submit" id="submitBtn" disabled>Submit</button>

</form>

<p id="message"></p>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Your mosque location
    const masjidLat = 12.9938519;
    const masjidLon = 77.6988981;
    const maxDistance = 5; // km
    let map, marker, userLat, userLon, userDistance;

    function toggleMap() {
        const method = document.getElementById("locMethod").value;
        const mapDiv = document.getElementById("map");
        document.getElementById("message").innerHTML = "";
        document.getElementById("submitBtn").disabled = true;

        if (method === "manual") {
            mapDiv.style.display = "block";
            if (!map) initMap();
        } else {
            mapDiv.style.display = "none";
        }
    }

    function initMap() {
        map = L.map('map').setView([masjidLat, masjidLon], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © OpenStreetMap contributors'
        }).addTo(map);

        marker = L.marker([masjidLat, masjidLon], {draggable:true}).addTo(map);

        marker.on('dragend', function(e) {
            const pos = marker.getLatLng();
            userLat = pos.lat;
            userLon = pos.lng;
        });

        map.on('click', function(e) {
            const pos = e.latlng;
            marker.setLatLng(pos);
            userLat = pos.lat;
            userLon = pos.lng;
        });

        userLat = masjidLat;
        userLon = masjidLon;
    }

    function verifyLocation() {
        const method = document.getElementById("locMethod").value;
        if (!method) {
            alert("Please select location method.");
            return;
        }

        if (method === "current") {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, geoError);
            } else {
                alert("Geolocation not supported.");
            }
        } else if (method === "manual") {
            userLat = marker.getLatLng().lat;
            userLon = marker.getLatLng().lng;
            checkDistance(userLat, userLon);
        }
    }

    function success(position) {
        userLat = position.coords.latitude;
        userLon = position.coords.longitude;
        checkDistance(userLat, userLon);
    }

    function geoError() {
        document.getElementById("message").innerHTML = "❌ Location permission required.";
        document.getElementById("submitBtn").disabled = true;
    }

    function checkDistance(lat, lon) {
        const distance = getDistance(lat, lon, masjidLat, masjidLon);
        const rounded = distance.toFixed(2);
        userDistance = rounded;

        if (distance <= maxDistance) {
            document.getElementById("message").innerHTML = `✅ Delivery is available! Please Submit Your request`;
            document.getElementById("submitBtn").disabled = false;
        } else {
            document.getElementById("message").innerHTML = `❌ Sorry! Sehri service is only available within ${maxDistance} km. You are currently ${rounded} km away.`;
            document.getElementById("submitBtn").disabled = true;
        }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI/180;
        const dLon = (lon2 - lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(lat1 * Math.PI/180) *
                  Math.cos(lat2 * Math.PI/180) *
                  Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

function submitToGoogleForm(e) {
    e.preventDefault();

    // Name
    const name = encodeURIComponent(document.getElementById("name").value);

    // Phone validation
    const phoneInput = document.getElementById("phone").value.trim();
    const phoneClean = phoneInput.replace(/\D/g, "");
    if (phoneClean.length !== 10) {
        document.getElementById("message").innerHTML = "❌ Please enter a valid 10-digit phone number.";
        return false;
    }
    const phone = encodeURIComponent(phoneClean);

    // Food preference
    const foodInput = document.getElementById("food").value;
    if (!foodInput) {
        document.getElementById("message").innerHTML = "❌ Please select your food preference.";
        return false;
    }
    const food = encodeURIComponent(foodInput);

    // Optional: Add dates if you have start/end date fields
    const startDate = document.getElementById("startDate")?.value || "";
    const endDate = document.getElementById("endDate")?.value || "";
    if (startDate && endDate && new Date(endDate) < new Date(startDate)) {
        document.getElementById("message").innerHTML = "❌ End date cannot be before start date.";
        return false;
    }

    const location = encodeURIComponent(`https://www.google.com/maps?q=${userLat},${userLon}`);
    const distance = encodeURIComponent(userDistance);

    // Replace GOOGLE_FORM_ID with your actual form's ID & entry IDs
    const googleFormURL = `https://docs.google.com/forms/d/e/1FAIpQLScM6yV_w_vCsJLspCpWdVEoEG2nY07Pr8t_mMJKVifY9mmMHg/formResponse?entry.924820124=${name}&entry.471336051=${phone}&entry.824975180=${food}&entry.1390853445=${location}&entry.144961159=${distance}`;

    // Submit silently using fetch
    fetch(googleFormURL, {
        method: "POST",
        mode: "no-cors" // prevents redirect to Google Form response page
    })
    .then(() => {
        document.getElementById("message").innerHTML = "✅";
        document.getElementById("message").innerHTML = "✅ Your registration has been sent! Please click X to close this Window";
        document.getElementById("submitBtn").disabled = true;
    })
    .catch(() => {
        document.getElementById("message").innerHTML = "❌ Something went wrong. Please try again!";
    });

    return false; // prevent default form submission
}

</script>

</body>
</html>

